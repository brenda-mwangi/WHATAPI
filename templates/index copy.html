<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bot Configuration with Multilingual and Download Support</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<header>
    <h1>Bot Configuration</h1>
    <button><a href="/user/logout">Logout</a></button>
</header>
<div class="content">
    <div id="formContainer">
        <form id="botConfigForm">
            <label for="userId">User ID:</label>
            <input type="number" id="userId" name="userId" required>

            <label for="languageCount">Number of Languages:</label>
            <input type="number" id="languageCount" value="2" min="1" max="10" onchange="prepareMenuTemplate();">
                
            <div id="menusContainer">
                <!-- Nested menus will be added here -->
            </div>
            <button type="button" onclick="addMenu('menusContainer', 0); updateJSON();">Add Main Menu</button>
            <button type="button" onclick="downloadJSON();">Download JSON</button>
            <button type="submit">Submit Configuration</button>
        </form>
    </div>
    <div id="jsonContainer">
        <h2>JSON Preview</h2>
        <textarea id="jsonOutput" readonly></textarea>
    </div>
</div>

<script>
let menuCounter = {};

// initialize template on load using current languageCount value
document.addEventListener("DOMContentLoaded", () => {
  prepareMenuTemplate();
  // optionally auto-add a starter menu so UI isn't empty:
  // addMenu('menusContainer', 0);
});

// log token for dev debugging
console.log(localStorage.getItem('access_token'));

function prepareMenuTemplate() {
    const languageCount = parseInt(document.getElementById('languageCount').value, 10) || 1;
    window.menuTemplate = generateMenuTemplate(languageCount);
    console.log('Template prepared for', languageCount, 'languages');
}

function generateMenuTemplate(languageCount) {
    let descriptionHTML = '';
    let textHTML = '';
    for (let i = 1; i <= languageCount; i++) {
        descriptionHTML += `<label>Description Language ${i}:</label>
                            <input type="text" class="description" data-lang="${i}" oninput="updateJSON()">`;
        textHTML += `<label>Text Language ${i}:</label>
                     <input type="text" class="text" data-lang="${i}" oninput="updateJSON()">`;
    }
    return { descriptionHTML, textHTML };
}

function addMenu(parentId, level) {
    // ensure template exists
    if (!window.menuTemplate) {
        prepareMenuTemplate();
    }

    // find parent container
    const parent = document.getElementById(parentId === 'menusContainer' ? 'menusContainer' : `sub${parentId}`);
    if (!parent) {
        console.error('Parent container not found for', parentId);
        return;
    }

    let existingMenus = parent.getElementsByClassName('menu');
    let maxDataValue = 0;
    Array.from(existingMenus).forEach(menu => {
        let value = parseInt(menu.getAttribute('data-value'), 10);
        if (!isNaN(value) && value > maxDataValue) maxDataValue = value;
    });
    let nextDataValue = maxDataValue + 1;

    let menuId = 'menu' + Date.now();
    let div = document.createElement('div');
    div.className = 'menu';
    div.id = menuId;
    div.setAttribute('data-value', nextDataValue);

    div.innerHTML = `
        <h2>Menu Level ${level}_${nextDataValue}</h2>
        <div class="descriptions">${window.menuTemplate.descriptionHTML}</div>
        <div class="texts">${window.menuTemplate.textHTML}</div>

        <label>Payload:</label>
        <input type="text" class="payload" oninput="updateJSON()">
        <label>Active:</label>
        <input type="checkbox" class="active" checked oninput="updateJSON()">

        <button type="button" onclick="addMenu('${menuId}', ${level + 1}); updateJSON();">Add Submenu</button>
        <button type="button" onclick="removeMenu('${menuId}'); updateJSON();">Remove Menu</button>
    `;

    let subMenusContainer = document.createElement('div');
    subMenusContainer.className = 'subMenus';
    subMenusContainer.id = `sub${menuId}`;
    div.appendChild(subMenusContainer);

    parent.appendChild(div);
    updateJSON();
}

function removeMenu(menuId) {
    let menu = document.getElementById(menuId);
    if (!menu) {
        console.error('No menu found with id:', menuId);
        return;
    }
    let parent = menu.parentNode;
    parent.removeChild(menu);

    // reindex remaining siblings
    let siblings = Array.from(parent.children).filter(c => c.classList && c.classList.contains('menu'));
    siblings.forEach((sibling, idx) => {
        let newIdx = Math.max(1, idx + 1);
        sibling.setAttribute('data-value', newIdx.toString());
        // also update the heading if you want:
        let h2 = sibling.querySelector('h2');
        if (h2) h2.textContent = h2.textContent.replace(/Level\s+\S+/, `Level_${newIdx}`);
    });

    updateJSON();
}

function updateJSON() {
    const jsonOutput = constructJSON(document.getElementById('menusContainer'));
    const jsonTextarea = document.getElementById('jsonOutput');
    jsonTextarea.value = JSON.stringify(jsonOutput, null, 2);
    autoResize(jsonTextarea);
}

function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.max(textarea.scrollHeight, 100) + 'px';
}

function constructJSON(element) {
    if (!element) return [];

    let result = [];
    let menus = element.children;

    for (let menu of menus) {
        if (!menu.classList.contains('subMenus')) {
            let descriptions = Object.fromEntries(
                Array.from(menu.querySelectorAll('.description')).map(input => [input.dataset.lang, input.value || ""])
            );
            let texts = Object.fromEntries(
                Array.from(menu.querySelectorAll('.text')).map(input => [input.dataset.lang, input.value || ""])
            );

            let payloadInput = menu.querySelector('input.payload') || menu.querySelector('input[type="text"]:not(.description):not(.text)');
            let payload = payloadInput ? payloadInput.value : '';

            let activeInput = menu.querySelector('input.active') || menu.querySelector('input[type="checkbox"]');
            let active = activeInput ? activeInput.checked : false;

            let subMenus = menu.querySelector('.subMenus');
            let content = subMenus ? constructJSON(subMenus) : [];

            let menuData = {
                code: menu.getAttribute('data-value'),
                description: descriptions,
                text: texts,
                payload: payload,
                active: active,
                content: content
            };
            result.push(menuData);
        }
    }
    return result;
}

function downloadJSON() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(document.getElementById('jsonOutput').value);
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "My_bot_config.json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}

// document.getElementById("botConfigForm").addEventListener("submit", async function (event) {
//     event.preventDefault();

//     const userId = document.getElementById("userId").value;

//     try {
//       const res = await fetch(`/bot/create-bot/${userId}`, {
//         method: "GET"
//       });

//       const data = await res.json();
//       console.log("Response:", data);
//       alert(data.message);
//     } catch (err) {
//       console.error("Error submitting form:", err);
//     }
//   });

</script>

</body>
</html>
